<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- RAE Capitalization applied -->
    <title>Plantilla de optimización financiera</title>
    <!-- Google Font: Lexend - Used for all text, including numbers and buttons -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define Umine Kit Brand Colors */
        :root {
            --color-navy: #1d2a4e;
            --color-sky: #00ade1;
            --color-yellow: #ffcd22;
            --color-green: #80b122;
            --color-gray: #ececec;
            --color-red: #da3728;
            --color-violet: #575e9a;
            --color-white: #ffffff;
            --color-text: #333333;
            --color-light-bg: #f7f7f7; /* Used only for input backgrounds now */
        }

        body {
            font-family: 'Lexend', sans-serif;
            background-color: var(--color-gray);
            color: var(--color-text);
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }

        /* General Card Styling */
        .card {
            background-color: var(--color-white);
            border-radius: 16px;
            padding: 30px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); 
            margin-bottom: 25px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Header Styling */
        header {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
        }

        header h1 {
            color: var(--color-navy);
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 5px;
        }

        header p {
            color: var(--color-violet);
            font-weight: 400;
            font-size: 1rem;
        }

        /* --- View Control --- */
        .view-content {
            display: none;
        }
        
        .view-content.active {
            display: block;
        }

        /* --- Input Panel Styling (Page 1) --- */
        .section-title {
            color: var(--color-navy);
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--color-sky); 
            padding-bottom: 5px;
        }

        /* Input group specifically for the Ingreso field to position the tooltip */
        .input-group-ingreso {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Push inputs/label to ends */
            margin-bottom: 15px;
        }

        .input-group-ingreso > label {
            margin-right: auto; /* Push label to the left */
        }
        
        /* Container for the input and its tooltip */
        .input-tooltip-container {
            display: flex;
            align-items: center;
        }
        
        /* Input styling (applies to ingreso and debt inputs) */
        .debt-input, .input-group-ingreso input[type="number"] {
            text-align: right !important; 
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Lexend', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box; /* Ensure padding doesn't break layout */
            width: 100%;
        }

        .debt-input:focus, .input-group-ingreso input[type="number"]:focus {
            border-color: var(--color-sky);
            box-shadow: 0 0 0 3px rgba(0, 173, 225, 0.2);
            outline: none;
        }
        
        /* Read-only input style */
        .debt-input[readonly] {
            background-color: #f0f0f0; /* Light gray background for automatic fields */
            color: var(--color-navy);
            font-weight: 600;
            cursor: default;
        }

        .debt-container {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        /* New Grid for Debt Header and Items (Desktop/Wide) */
        .debt-grid {
            display: grid;
            /* 6 columns: Name (2fr) | Monto (1.4fr) | Tasa (1fr) | Term (1fr) | Cuota (1.4fr) | Actions (50px - FIXED WIDTH) */
            grid-template-columns: 2fr 1.4fr 1fr 1fr 1.4fr 50px; 
            gap: 10px;
            align-items: center;
        }

        .debt-header {
            margin-bottom: 5px;
            padding: 0; /* No padding on the grid row itself */
            border-bottom: 1px solid #ddd;
        }

        /* --- FINAL ALIGNMENT SOLUTION: Readonly Inputs for Headers --- */
        .debt-header-input {
            font-family: 'Lexend', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-violet);
            
            /* Make it look like text, not an input */
            background-color: transparent;
            border: none;
            box-shadow: none;
            outline: none;
            cursor: default;
            
            /* --- ALIGNMENT FIX --- */
            padding: 10px 12px; 
            /* Align right for numbers, left for the text 'Deuda' */
            text-align: right; 
            width: 100%; 
            box-sizing: border-box; 
        }
        
        /* Modifier for the 'Deuda' header (text) */
        .debt-header-input.header-label {
            text-align: left; 
            padding-left: 10px; 
        }
        /* --- End of Final Alignment Solution --- */

        
        /* Styles for editable text input (Deuda name) */
        .debt-item input[type="text"] {
            font-family: 'Lexend', sans-serif;
            font-weight: 400; 
            color: var(--color-navy);
            text-align: left;
            padding: 10px;
            border: 1px solid #ddd; 
            background-color: var(--color-light-bg); /* Use light grey for these text fields */
            border-radius: 8px;
            font-size: 1rem;
            cursor: text;
            box-sizing: border-box;
            width: 100%;
        }

        .debt-item input[type="text"]:focus {
            border-color: var(--color-sky);
            box-shadow: 0 0 0 3px rgba(0, 173, 225, 0.2);
            outline: none;
        }
        
        /* Alignment for totals row */
        .total-row {
            grid-template-columns: 2fr 1.4fr 1fr 1fr 1.4fr 50px; /* Match debt grid structure (6 columns) */
        }
        
        .total-row span:first-child {
            text-align: left; /* Totales label */
            padding-left: 10px; /* Align with 'Deuda' header/input */
        }
        
        /* Totals Monto aligned right */
        .total-row span:nth-child(2) 
        {
            text-align: right; 
            padding-right: 12px; 
            font-weight: 700;
            color: var(--color-navy);
        }
        
        /* Totals Pago aligned right, matching input right edge. Now it's the 5th item */
        .total-row span:nth-child(5) 
        {
            text-align: right; 
            padding-right: 12px; 
            font-weight: 700;
            color: var(--color-navy);
        }
        
        /* Placeholders for Tasa (3) and Plazo (4) */
        .total-row span:nth-child(3), 
        .total-row span:nth-child(4), 
        .total-row span:nth-child(6) 
        {
            text-align: center; 
        }

        /* --- MOBILE/RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            /* Mobile now stacks items to display 4 essential fields */
            .debt-grid {
                grid-template-columns: 1fr 1fr; /* Default 2 columns for smaller inputs */
                gap: 5px;
                padding-top: 10px;
                border: 1px solid #ddd;
                border-radius: 8px;
                margin-bottom: 10px;
            }

            .debt-header {
                display: none; /* Hide desktop headers */
            }

            .debt-item {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            /* Debt Name takes full width, Actions moves to its own row with buttons */
            .debt-item input[type="text"] {
                grid-column: span 2;
                font-weight: 600;
                background-color: var(--color-white);
            }

            /* Stack Monto and Tasa/Plazo/Cuota in two columns */
            .debt-item input[name*="-monto"] {
                grid-column: 1 / 2;
            }
            .debt-item input[name*="-tasa"] {
                grid-column: 2 / 3;
            }
            .debt-item input[name*="-term"] {
                grid-column: 1 / 2;
            }
            .debt-item input[name*="-pago"] {
                grid-column: 2 / 3;
            }
            
            /* Actions row at the bottom of the stacked item */
            .debt-actions {
                grid-column: span 2;
                justify-content: flex-start;
                padding-right: 0;
                padding-left: 5px;
                padding-bottom: 5px;
                width: auto; /* Reset fixed width on mobile */
            }

            /* Adjust Totals Row for Mobile */
            .total-row {
                grid-template-columns: 1fr 1fr; /* Totals Label + Total Monto/Pago */
                padding: 10px;
                border: none;
                background-color: var(--color-light-bg);
                border-radius: 8px;
            }
            .total-row span:first-child {
                grid-column: span 2; /* "Totales" label spans the row */
                text-align: center;
                border-bottom: 1px solid #ddd;
                padding-bottom: 5px;
                margin-bottom: 5px;
            }
             .total-row span:nth-child(2) /* Total Monto */
            {
                text-align: right;
                padding-right: 10px;
            }
            .total-row span:nth-child(5) /* Total Pago (now 5th item) */
            {
                text-align: right;
                padding-right: 10px;
            }
            /* Hide Tasa and Plazo columns on mobile total row */
            .total-row span:nth-child(3), .total-row span:nth-child(4), .total-row span:nth-child(6) {
                display: none; 
            }
        }

        /* Tooltip Styling (Solid Color) */
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 10px; 
            cursor: help;
        }

        .tooltip-icon {
            /* Draw the solid circle and center the 'i' */
            color: var(--color-white); 
            background-color: var(--color-sky); 
            font-weight: 700; 
            font-size: 0.9rem; 
            line-height: 18px; 
            display: flex; 
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            user-select: none;
            box-shadow: none;
            border: none;
            outline: none;
        }

        .tooltip-text {
            visibility: hidden;
            background-color: var(--color-navy);
            color: var(--color-white);
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10; 
            bottom: 125%; 
            right: 0; 
            transform: translateX(50%); 
            width: 200px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Action Buttons within Debt Rows */
        .debt-actions {
            /* FIX: Fixed width (50px) to prevent shift when '+' button disappears/appears */
            width: 50px; 
            display: flex;
            gap: 5px;
            justify-content: space-between; 
            padding-right: 5px;
            height: 100%; 
            align-items: center; 
        }

        .btn-row-action {
            font-size: 0.8rem; 
            padding: 2px 5px; 
            line-height: 1;
            border-radius: 6px; 
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            color: var(--color-white);
            height: 24px; 
            width: 24px; 
        }
        
        /* Green for Add */
        .btn-add {
            background-color: var(--color-green); 
        }
        .btn-add:hover {
            background-color: #6a951c;
        }

        /* Red for Remove */
        .btn-remove {
            background-color: var(--color-red); 
        }
        .btn-remove:hover {
            background-color: #b82d22;
        }

        /* --- Summary/Output Panel Styling (Page 2) --- */
        .summary-card-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px;
            margin-bottom: 40px;
        }
        
        /* Responsive adjustments for KPI grid */
        @media (max-width: 1100px) {
            .summary-card-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) {
            .summary-card-container {
                grid-template-columns: 1fr;
            }
        }

        .summary-kpi-card {
            background-color: var(--color-white);
            border-radius: 12px;
            padding: 20px; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
        }
        
        .kpi-title {
            font-size: 0.9rem;
            color: var(--color-violet); 
            font-weight: 400;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.8rem; 
            font-weight: 700;
            margin-top: 5px;
            color: var(--color-navy); 
            font-family: 'Lexend', sans-serif; 
        }
        
        .kpi-value.positive { color: var(--color-green); }
        .kpi-value.negative { color: var(--color-red); }
        .kpi-value.alert { color: var(--color-yellow); }

        /* Strategy Section Styles */
        #strategy-content {
            background-color: var(--color-navy);
            color: var(--color-white);
            padding: 30px; 
            border-radius: 16px;
        }

        #strategy-content h3 {
            color: var(--color-yellow);
            font-size: 1.8rem;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 700;
        }

        #strategy-content h4 {
            color: var(--color-sky);
            font-size: 1.3rem;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        
        #strategy-content p {
            font-size: 1rem;
            margin-bottom: 15px;
        }

        #strategy-content ul {
            list-style: none;
            padding-left: 0;
        }

        #strategy-content li {
            margin-bottom: 12px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        /* Highlight styles for negritas (strong) */
        #strategy-content strong {
            font-weight: 700;
        }
        
        .btn {
            font-family: 'Lexend', sans-serif; 
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            text-transform: uppercase;
        }
        
        .btn-sky {
            background-color: var(--color-sky);
            color: var(--color-white);
            box-shadow: 0 4px 8px rgba(0, 173, 225, 0.3);
        }

        .btn-sky:hover {
            background-color: #008cc3;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 173, 225, 0.4);
        }


        /* Final Utility Classes */
        .currency::before { content: '$ '; } 
        .percent::after { content: ' %'; }
        
        .main-content {
            padding-bottom: 80px; 
        }
        
        .summary-section-title {
            color: var(--color-navy);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* Disclaimer Styling */
        .disclaimer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 0.85rem;
            color: var(--color-violet);
        }
    </style>
</head>
<body>

    <header>
        <h1>Carga financiera y optimización de deudas</h1>
        <p>Calcula tu carga financiera y evalúa la mejor estrategia para pagar tus compromisos.</p>
    </header>

    <div class="main-content">
        
        <!-- VIEW 1: CALCULATOR (INPUT) -->
        <div id="input-view" class="view-content active">
            <div class="card">
                <h2 class="section-title">Ingresos mensuales</h2>
                <form id="financial-form">
                    <!-- Ingresos -->
                    <div class="input-group-ingreso">
                        <label for="ingreso_neto">Sueldo / Ingreso neto total</label>
                        <div class="input-tooltip-container">
                             <input type="number" id="ingreso_neto" name="ingreso_neto" value="1500000" min="0" step="1" pattern="[0-9]*">
                            <div class="tooltip-container">
                                <span class="tooltip-icon">i</span><!-- ICONO CORREGIDO A 'i' SIMPLE -->
                                <span class="tooltip-text">Cantidad neta que recibes de forma recurrente cada mes.</span>
                            </div>
                        </div>
                    </div>

                    <h2 class="section-title" style="margin-top: 30px;">Compromisos financieros (Deudas)</h2>
                    
                    <!-- Debt Structure (Table-like) -->
                    <div class="debt-container">
                        <!-- FINAL SOLUTION: Use readonly inputs for headers to guarantee alignment -->
                        <div class="debt-grid debt-header">
                            <input type="text" readonly class="debt-header-input header-label" value="Deuda">
                            <input type="text" readonly class="debt-header-input" value="Monto adeudado ($)">
                            <input type="text" readonly class="debt-header-input" value="Tasa/CAE (%)"> <!-- CAMBIO A TASA/CAE (%) -->
                            <!-- NUEVA COLUMNA PLAZO -->
                            <input type="text" readonly class="debt-header-input" value="Plazo (meses)">
                            <input type="text" readonly class="debt-header-input" value="Cuota mensual ($)">
                            <span></span> <!-- Actions placeholder -->
                        </div>
                        
                        <div id="debt-items-container">
                            <!-- Debt items will be dynamically inserted here by JS -->
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="debt-grid total-row" style="margin-top: 15px; font-weight: 600; color: var(--color-navy);">
                        <span style="text-align: left;">Totales</span>
                        <!-- Monto (2) -->
                        <span id="kpi-total-deuda-monto-input" class="currency"></span>
                        <!-- Tasa (3) -->
                        <span></span> 
                        <!-- Plazo (4) -->
                        <span></span>
                        <!-- Pago (5) -->
                        <span id="kpi-total-deudas-pago-input" class="currency"></span>
                        <span></span> <!-- Empty space for removed button (6) -->
                    </div>
                </form>
            </div>
            
            <!-- Button to navigate to Summary View -->
            <div style="text-align: center; margin-top: 30px;">
                 <button class="btn btn-sky" onclick="showView('summary-view')">Ver resumen y estrategia</button>
            </div>
        </div>
        
        <!-- VIEW 2: SUMMARY AND STRATEGY -->
        <div id="summary-view" class="view-content">
            <div class="card">
                <h2 class="summary-section-title">Resumen de métricas claves</h2>
                <div class="summary-card-container">
                    <!-- KPI 1: Ingreso Neto Total -->
                    <div class="summary-kpi-card">
                        <p class="kpi-title">Ingreso neto total</p>
                        <div class="kpi-value neutral currency" id="kpi-total-ingresos"></div>
                    </div>

                    <!-- KPI 2: Compromisos de Deuda Mensual -->
                    <div class="summary-kpi-card">
                        <p class="kpi-title">Pago mensual total de deudas</p>
                        <div class="kpi-value neutral currency" id="kpi-total-deudas-pago-kpi"></div>
                    </div>

                    <!-- KPI 3: Carga Financiera (CRÍTICO) -->
                    <div class="summary-kpi-card" id="card-carga-financiera">
                        <p class="kpi-title">Carga financiera (%)</p>
                        <div class="kpi-value neutral percent" id="kpi-carga-financiera"></div>
                    </div>
                    
                    <!-- KPI 4: Carga Financiera Status (New Simplified Status Card) -->
                    <div class="summary-kpi-card" id="card-status-carga">
                        <p class="kpi-title">Nivel de riesgo</p>
                        <div class="kpi-value neutral" id="kpi-status-carga" style="font-size: 1.5rem;"></div>
                    </div>

                </div>
                
                <h2 class="summary-section-title" style="margin-top: 40px;">Sugerencias de optimización</h2>
                <div id="strategy-content">
                    <ul id="recommendation-list">
                        <li>Calculando...</li>
                    </ul>
                    <div id="debt-strategy" style="display:none;">
                        
                    </div>
                </div>
            </div>
            
             <!-- Button to navigate back to Calculator View -->
            <div style="text-align: center; margin-top: 30px;">
                 <button class="btn btn-sky" onclick="showView('input-view')">Volver a la calculadora</button>
            </div>
        </div>
    </div>

    <footer class="disclaimer">
        <p>Esta herramienta es de carácter informativo y no sustituye la asesoría financiera profesional.</p>
    </footer>

    <script>
        // --- Global Configuration and Setup ---
        const FORM_ID = 'financial-form';
        const STORAGE_KEY = 'financialSimulatorData_DebtOpt_V5'; 
        
        // Initial data matching the provided spreadsheet example
        const initialData = {
            ingreso_neto: 1500000,
            
            // Debts array structure: { name, monto, tasa, pago, term }
            debts: [
                { name: 'Tarjeta de crédito', monto: 500000, tasa: 30, term: 24, pago: 0 },
                { name: 'Crédito consumo', monto: 2000000, tasa: 18, term: 36, pago: 0 },
                { name: 'Crédito automotriz', monto: 6000000, tasa: 12, term: 60, pago: 0 },
                { name: '', monto: 0, tasa: 0, term: 60, pago: 0 } // Empty row 4
            ]
        };

        const form = document.getElementById(FORM_ID);
        const debtContainer = document.getElementById('debt-items-container');
        let currentData = { ...initialData };
        // Default term is now only used for initialization of new rows
        const DEFAULT_TERM = 60; 

        // Define the formatter outside functions for global use (Chilean format)
        const currencyFormatter = new Intl.NumberFormat('es-CL', { style: 'decimal', maximumFractionDigits: 0 });
        const decimalFormatter = new Intl.NumberFormat('es-CL', { style: 'decimal', minimumFractionDigits: 1, maximumFractionDigits: 1 });

        // --- Input Validation Function (New Addition) ---
        /**
         * Cleans input value to allow only non-negative integers (or non-negative float for Tasa).
         * @param {HTMLElement} inputElement - The input field being validated.
         */
        function cleanInput(inputElement) {
            let value = inputElement.value;
            const isTasa = inputElement.name.includes('-tasa');

            if (isTasa) {
                // Tasa/CAE allows numbers and single comma/dot for decimal
                // Replace comma with dot for JS calculation and allow only one dot/comma
                value = value.replace(/,/g, '.');
                // Remove any characters that aren't digits or the first dot
                value = value.replace(/[^\d.]/g, '');
                value = value.replace(/^(\d*\.?\d*).*$/, (match, group1) => group1);
            } else {
                // Monto, Ingreso, Plazo only allow non-negative integers (including zero)
                value = value.replace(/[^0-9]/g, '');
            }
            
            // Ensure non-negative (min="0" already prevents negative sign, but this is a double-check)
            if (value.startsWith('-')) {
                value = '0';
            }

            // Restore comma for display in Tasa/CAE if it was used for entry
            if (isTasa) {
                inputElement.value = value.replace('.', ',');
            } else {
                inputElement.value = value;
            }
        }


        /**
         * Calculates the periodic payment (PMT) for a loan based on principal, rate, and term.
         * Formula adapted for annual percentage rate (CAE).
         * @param {number} ratePercent - Annual interest rate (CAE) as a percentage (e.g., 18).
         * @param {number} periods - Total number of payments (months).
         * @param {number} presentValue - The principal loan amount (Monto adeudado).
         * @returns {number} The periodic payment amount.
         */
        function calculatePayment(ratePercent, periods, presentValue) {
            // If principal is zero, payment is zero regardless of rate/term.
            if (presentValue <= 0) {
                return 0;
            }
            
            // If term is zero, return 0 or handle as error (we return 0 for safe UI)
            if (periods <= 0) {
                return 0;
            }

            // CORRECTION: Handle 0% interest rate (CAE = 0)
            if (ratePercent <= 0) {
                // If 0% interest, payment is simply Principal / Term
                return Math.ceil(presentValue / periods);
            }

            // Convert annual rate percentage to monthly decimal rate
            const monthlyRate = (ratePercent / 100) / 12;
            
            // Standard PMT formula: P = [r * PV] / [1 - (1 + r)^(-n)]
            const payment = (monthlyRate * presentValue) / (1 - Math.pow(1 + monthlyRate, -periods));
            
            // Round up to nearest peso 
            return Math.ceil(payment);
        }
        
        // --- View Control ---
        function showView(viewId) {
            // Hide all content views
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show the selected view
            document.getElementById(viewId).classList.add('active');
            
            // Ensure calculation runs when changing to summary view
            if (viewId === 'summary-view') {
                calculateAndRender();
            }
        }

        // --- Debt Management (Dynamic Rows) ---

        /**
         * Renders a single debt row template.
         * @param {number} index - The index of the debt (0-based for array storage).
         * @param {object} data - The debt data { name, monto, tasa, pago, term }.
         * @param {boolean} isLast - True if this is the last row, which determines if the "+" button is visible.
         */
        function renderDebtRow(index, data, isLast) {
            const rowId = `debt-${index}`;
            
            // The REMOVE button is always first (left)
            const removeButton = `<button type="button" class="btn-row-action btn-remove" onclick="removeDebtRow(${index})" aria-label="Quitar fila de deuda">-</button>`;
                
            // The ADD button is only visible for the last row (right)
            const addButton = isLast ? 
                `<button type="button" class="btn-row-action btn-add" onclick="addDebtRowAfter(${index})" aria-label="Agregar fila después">+</button>` : 
                '';
            
            // NOTE: The 'pago' input is now READONLY because it is calculated automatically
            const template = `
                <div class="debt-grid debt-item" data-index="${index}" id="${rowId}">
                    <input type="text" name="deuda${index}-name" value="${data.name}" placeholder="Nombre de la deuda">
                    <input type="number" name="deuda${index}-monto" value="${data.monto}" min="0" step="1" class="debt-input" pattern="[0-9]*" placeholder="0">
                    <input type="number" name="deuda${index}-tasa" value="${data.tasa.toString().replace('.', ',')}" min="0" step="0.1" class="debt-input" placeholder="0,0">
                    <input type="number" name="deuda${index}-term" value="${data.term}" min="0" step="1" class="debt-input" pattern="[0-9]*" placeholder="0"> <!-- NEW PLAZO INPUT -->
                    <input type="number" name="deuda${index}-pago" value="${data.pago}" min="0" step="1" class="debt-input" pattern="[0-9]*" placeholder="0" readonly>
                    
                    <div class="debt-actions">
                        ${removeButton}
                        ${addButton}
                    </div>
                </div>
            `;
            debtContainer.insertAdjacentHTML('beforeend', template);
        }
        
        /**
         * Adds a new empty row to the debt table after a specific index.
         */
        function addDebtRowAfter(afterIndex) {
            const newDebt = { name: '', monto: 0, tasa: 0, term: DEFAULT_TERM, pago: 0 };
            currentData.debts.splice(afterIndex + 1, 0, newDebt);
            
            // Re-render the entire list to update indices and button visibility
            renderAllDebtRows();
            calculateAndRender();
        }

        /**
         * Removes a row from the debt array, updates the UI, and recalculates.
         * @param {number} indexToRemove - The index of the row to remove.
         */
        function removeDebtRow(indexToRemove) {
            if (currentData.debts.length > 1) {
                currentData.debts.splice(indexToRemove, 1);
            } else {
                // If only one row remains, just clear its data instead of removing it
                currentData.debts[0] = { name: '', monto: 0, tasa: 0, term: DEFAULT_TERM, pago: 0 };
            }
            
            // Re-render the entire list to correct indices and button visibility
            renderAllDebtRows();
            calculateAndRender();
        }
        
        /**
         * Clears the container and renders all debt rows from currentData.debts.
         */
        function renderAllDebtRows() {
            debtContainer.innerHTML = '';
            const totalDebts = currentData.debts.length;
            currentData.debts.forEach((debt, index) => {
                const isLast = (index === totalDebts - 1);
                renderDebtRow(index, debt, isLast);
            });
        }


        // --- Utility Functions ---

        /**
         * Parses form data and calculates key financial metrics, focusing on Carga Financiera.
         * NOTE: This function now calculates the 'pago' (cuota) automatically.
         * @returns {object} Calculated metrics.
         */
        function calculateMetrics() {
            // 1. Get Ingreso Neto
            const totalIngresos = parseInt(document.getElementById('ingreso_neto').value) || 0;
            
            // 2. Build the Debts array from current input values and calculate 'pago'
            const newDebts = [];
            let deudaPagos = 0;
            let deudaMontos = 0;
            
            // Use querySelectorAll to find all current debt rows
            document.querySelectorAll('#debt-items-container .debt-item').forEach(row => {
                const index = parseInt(row.dataset.index);
                
                // Fetch values using the name attribute based on the row's data index
                const nameInput = row.querySelector(`input[name="deuda${index}-name"]`);
                const montoInput = row.querySelector(`input[name="deuda${index}-monto"]`);
                const tasaInput = row.querySelector(`input[name="deuda${index}-tasa"]`);
                const termInput = row.querySelector(`input[name="deuda${index}-term"]`); // NEW TERM INPUT
                const pagoInput = row.querySelector(`input[name="deuda${index}-pago"]`);

                // Tasa must be converted from comma to dot for JS calculation
                const rawTasa = tasaInput.value.replace(/,/g, '.');
                
                const monto = parseInt(montoInput.value) || 0;
                const tasa = parseFloat(rawTasa) || 0;
                const term = parseInt(termInput.value) || 0; // Use input value for term
                
                // *** AUTOMATIC CALCULATION ***
                // Payment calculation now uses the user-provided term
                const calculatedPago = calculatePayment(tasa, term, monto);
                pagoInput.value = calculatedPago; // Update the readonly input field
                // *****************************

                deudaPagos += calculatedPago;
                deudaMontos += monto;

                newDebts.push({
                    name: nameInput.value,
                    monto: monto,
                    tasa: tasa,
                    term: term,
                    pago: calculatedPago
                });
            });
            
            currentData.ingreso_neto = totalIngresos;
            currentData.debts = newDebts; 

            // 3. Core Metrics for Module 5
            const cargaFinanciera = totalIngresos > 0 ? (deudaPagos / totalIngresos) * 100 : 0;

            // 4. Filter for analysis (Only debts with names or positive values)
            const activeDebts = newDebts.filter(d => (d.pago > 0 || d.monto > 0) && d.name.trim() !== '');

            return {
                totalIngresos,
                deudaPagos, 
                deudaMontos,
                cargaFinanciera,
                debts: activeDebts 
            };
        }

        /**
         * Renders the calculated metrics onto the KPI dashboard cards (Page 2) and totals row (Page 1).
         * @param {object} metrics - Calculated financial metrics.
         */
        function renderKpis(metrics) {
            const { totalIngresos, deudaPagos, cargaFinanciera, deudaMontos } = metrics;
            
            // Function to update KPI value and style
            const updateKpi = (id, value, isCurrency = true) => {
                const element = document.getElementById(id);
                if (!element) return;
                
                const formattedValue = isCurrency 
                    ? currencyFormatter.format(Math.round(value))
                    : decimalFormatter.format(value);
                
                element.textContent = formattedValue;
                
                // Reset classes
                element.classList.remove('positive', 'negative', 'alert', 'neutral');
                let statusClass = 'neutral';
                
                if (id === 'kpi-carga-financiera') {
                    // CRITICAL: Max 30% rule for non-mortgage
                    if (value <= 30) {
                        statusClass = 'positive';
                        document.getElementById('kpi-status-carga').textContent = 'Saludable';
                        document.getElementById('kpi-status-carga').classList.remove('negative', 'alert');
                        document.getElementById('kpi-status-carga').classList.add('positive');
                    } else if (value <= 40) {
                        statusClass = 'alert';
                        document.getElementById('kpi-status-carga').textContent = 'Moderado';
                        document.getElementById('kpi-status-carga').classList.remove('positive', 'negative');
                        document.getElementById('kpi-status-carga').classList.add('alert');
                    } else {
                        statusClass = 'negative'; 
                        document.getElementById('kpi-status-carga').textContent = 'Alto Riesgo';
                        document.getElementById('kpi-status-carga').classList.remove('positive', 'alert');
                        document.getElementById('kpi-status-carga').classList.add('negative');
                    }
                }
                
                element.classList.add(statusClass);
                element.classList.add(isCurrency ? 'currency' : 'percent');
            };

            // Update main KPIs (Page 2)
            updateKpi('kpi-total-ingresos', totalIngresos);
            updateKpi('kpi-total-deudas-pago-kpi', deudaPagos); // KPI card for total payment
            updateKpi('kpi-carga-financiera', cargaFinanciera, false);
            
            // Update summary row under the debt table (Page 1)
            document.getElementById('kpi-total-deuda-monto-input').textContent = currencyFormatter.format(deudaMontos);
            document.getElementById('kpi-total-deudas-pago-input').textContent = currencyFormatter.format(deudaPagos);
        }

        /**
         * Calculates the optimal debt strategy and generates recommendations based on module content.
         */
        function generateRecommendations(metrics) {
            const { cargaFinanciera, totalIngresos, deudaPagos, debts } = metrics;
            const recList = document.getElementById('recommendation-list');
            const debtStrategyElement = document.getElementById('debt-strategy');
            recList.innerHTML = ''; // Clear previous recommendations
            const recommendations = [];
            
            // 1. Carga Financiera Status
            if (totalIngresos > 0 && cargaFinanciera > 30) {
                const targetDebtReduction = (deudaPagos - (totalIngresos * 0.30));
                const formattedTargetReduction = currencyFormatter.format(Math.round(targetDebtReduction));
                recommendations.push(`<strong>Meta de equilibrio:</strong> Para alcanzar el 30% recomendado, debes reducir el pago mensual de deudas en al menos <span style="color:var(--color-yellow); font-weight:700;">$ ${formattedTargetReduction}</span>. Evalúa la consolidación.`);
            } else if (totalIngresos > 0) {
                 recommendations.push(`¡Felicidades! Tu carga financiera (${decimalFormatter.format(cargaFinanciera)}%) está bajo control. Enfócate en la estrategia de pago para liquidar deudas rápidamente.`);
            } else {
                 recommendations.push('Ingresa tu ingreso neto mensual para obtener un diagnóstico.');
            }

            // 2. Debt Strategy and Consolidation
            if (debts.length >= 2) {
                debtStrategyElement.style.display = 'block';
                const strategyResult = calculateDebtStrategy(debts);
                debtStrategyElement.innerHTML = strategyResult.description;
                
                if (cargaFinanciera > 30) {
                     recommendations.push(`<strong>Estrategia de Consolidación:</strong> La opción más rápida para bajar tu carga financiera es unificar deudas caras (alto CAE) en un producto con menor tasa y mayor plazo.`);
                }
            } else {
                 debtStrategyElement.style.display = 'none';
                 if(debts.length === 1) {
                     recommendations.push(`Solo tienes una deuda activa (${debts[0].id}). Prioriza pagarla para avanzar a la libertad financiera.`);
                 }
            }
            
            if (recommendations.length === 0) {
                 recommendations.push('Ingresa tus datos para obtener un diagnóstico personalizado.');
            }

            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.innerHTML = `• ${rec}`;
                recList.appendChild(li);
            });
        }

        /**
         * Calculates the optimal debt strategy (Snowball vs. Avalanche) for the recommendations panel.
         * @param {Array<object>} debts - List of active debts {id, monto, tasa}.
         */
        function calculateDebtStrategy(debts) {
            // Filter out debts with 0 monto (for cleaner focus)
            const activeDebts = debts.filter(d => d.monto > 0 && d.tasa > 0);
            
            if (activeDebts.length < 2) {
                return { description: '' };
            }

            // 1. Avalanche: Highest interest rate (CAE) first (Saves most money)
            const avalanchePriority = activeDebts.slice().sort((a, b) => b.tasa - a.tasa); 
            const highestRate = avalanchePriority[0];

            // 2. Snowball: Smallest balance first (Quickest win/motivation)
            const snowballPriority = activeDebts.slice().sort((a, b) => a.monto - b.monto);
            const smallestMonto = snowballPriority[0];
            
            const strategyContent = `
                <h4>Estrategias de pago</h4>
                <p>Elige tu enfoque de acuerdo a tu perfil de pago:</p>
                <ul>
                    <li><strong>Avalancha (Ahorro de intereses):</strong> Prioriza la deuda con mayor CAE: <strong>${highestRate.name || 'Deuda sin nombre'}</strong> (${decimalFormatter.format(highestRate.tasa)}%). Ahorras más intereses en el largo plazo.</li>
                    <li><strong>Bola de nieve (Motivación):</strong> Prioriza la deuda con menor monto: <strong>${smallestMonto.name || 'Deuda sin nombre'}</strong> ($${currencyFormatter.format(smallestMonto.monto)}). Logras victorias rápidas para mantener la motivación.</li>
                    <li><strong>Híbrida:</strong> Combina ambas según tu necesidad (ej: paga la más pequeña por motivación, luego enfócate en la más cara).</li>
                </ul>
            `;

            return {
                strategy: 'Avalancha o Bola de Nieve',
                description: strategyContent
            };
        }
        
        // --- Storage and Initialization ---

        /**
         * Loads data from localStorage and populates the form structure.
         */
        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                const data = savedData ? JSON.parse(savedData) : initialData;
                
                // Load Ingreso Neto
                const ingresoInput = document.getElementById('ingreso_neto');
                if (ingresoInput) {
                    ingresoInput.value = data.ingreso_neto || initialData.ingreso_neto;
                }
                
                // Update currentData structure
                currentData.ingreso_neto = data.ingreso_neto || initialData.ingreso_neto;
                currentData.debts = data.debts || initialData.debts;

            } catch (error) {
                console.error("Error loading data from localStorage:", error);
                // Fallback to initial data structure rendering if loading fails
                currentData = { ...initialData };
            }
            // Always render rows based on loaded data
            renderAllDebtRows();
        }

        /**
         * Saves current form data (including dynamic debts) to localStorage.
         */
        function saveData() {
            try {
                // Ensure currentData is updated from the DOM before saving
                calculateMetrics(); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
            } catch (error) {
                console.error("Error saving data to localStorage:", error);
            }
        }
        
        /**
         * Main function to handle recalculation and UI update.
         */
        function calculateAndRender() {
            const metrics = calculateMetrics();
            renderKpis(metrics);
            generateRecommendations(metrics);
            saveData();
        }

        // --- Event Listeners and Initial Load ---
        window.onload = function() {
            // 1. Load data and render rows
            loadData();
            calculateAndRender(); 
            
            // 2. Attach listener to the form container for real-time updates (uses event delegation)
            form.addEventListener('input', (event) => {
                // Apply cleaning function to all relevant inputs before calculation
                if (event.target.type === 'number') {
                    cleanInput(event.target);
                }
                calculateAndRender();
            });
            
            // 3. Set up the initial view (Calculator is always first)
            showView('input-view'); 
        };

    </script>
</body>
</html>
