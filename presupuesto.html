<!--
    Developer Comments in English.
    All UI elements, labels, and instructional text are in Spanish, as requested.
    This application is fully contained in a single HTML file, using embedded CSS and JavaScript.
    FIXED: 
    1. EXPORT FUNCTION: Switched the delimiter to semicolon (;) and changed the downloaded file extension to .csv (with a .xlsx visual label) for maximum compatibility with Latin American Excel settings, which resolves the 'file corrupted' error.
    2. Feedback messages (updateFeedbackMessage) remain concise and direct.
    3. Input validation and navigation are fully functional.
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de presupuesto mensual</title>
    <!-- Lexend Font Import -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables based on Umine Kit Palette */
        :root {
            --color-navy: #1d2a4e;
            --color-sky-blue: #00ade1;
            --color-yellow: #ffcd22;
            --color-green: #80b122;
            --color-red: #da3728;
            --color-violet: #575e9a;
            --color-white: #ffffff;
            --color-text-dark: #333;
            --color-border: #ddd;
            --color-gray: #ececec;
            --font-family: 'Lexend', sans-serif;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-card: 0 10px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        /* General Body and Typography */
        body {
            font-family: var(--font-family);
            background-color: var(--color-gray);
            color: var(--color-text-dark);
            margin: 0;
            padding: 20px 10px;
            line-height: 1.6;
            min-height: 10vh;
            font-weight: 400; /* Ensure base text is Lexend regular */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        h1 {
            color: var(--color-navy);
            text-align: center;
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 2.2rem;
        }
        
        .disclaimer-title {
            color: var(--color-sky-blue);
            text-align: center;
            font-weight: 400;
            font-size: 1.1rem;
            margin-top: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Card Styles */
        .card {
            background-color: var(--color-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            padding: 25px;
        }

        /* Summary Section - Top Dashboard */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-item {
            padding: 20px;
            text-align: center;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
        }

        .summary-label {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: none; 
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        /* Specific Summary Colors */
        #total-income-display { background-color: #e6f7d9; color: var(--color-green); }
        #total-expenses-display { background-color: #fcebeb; color: var(--color-red); }
        #monthly-balance-display.positive { background-color: #d9f7f7; color: var(--color-sky-blue); }
        #monthly-balance-display.negative { background-color: #f7e6e6; color: var(--color-red); }
        #monthly-balance-display.zero { background-color: #f0f0f0; color: var(--color-text-dark); }

        /* --- Tab Styles --- */
        /* Removed .tab-controls display as it's no longer needed for navigation */
        .tab-controls {
            display: none; /* Hide the tab control bar */
            border-bottom: 2px solid var(--color-border);
            margin-bottom: 20px;
        }
        /* Keep tab content styling for showing/hiding main sections */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* Expense Category Breakdown Layout */
        .breakdown-layout {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .breakdown-card {
            display: grid;
            grid-template-columns: 1fr; /* Default: stack on mobile */
            gap: 25px;
        }
        
        .breakdown-chart-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .breakdown-list-area {
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .breakdown-card {
                grid-template-columns: 2fr 3fr; /* Side-by-side on desktop/tablet */
            }
            .breakdown-chart-area {
                align-items: flex-start;
            }
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--color-border);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-label {
            font-weight: 600;
            color: var(--color-navy);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .breakdown-value-wrapper {
             display: flex;
             align-items: center;
             gap: 10px;
             font-weight: 400;
             text-align: right;
        }

        .breakdown-percentage {
            min-width: 60px;
            text-align: right;
            font-weight: 700;
            color: var(--color-violet);
        }

        .breakdown-percentage.over { color: var(--color-red); }
        .breakdown-percentage.ok { color: var(--color-green); }

        /* Chart Canvas */
        #chart-canvas {
            max-width: 300px;
            max-height: 300px;
            width: 100%;
            height: auto;
            margin-bottom: 15px;
        }

        /* Feedback Message - Full Width below breakdown-card */
        #feedback-message {
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            line-height: 1.4;
            margin-top: 15px;
        }
        .feedback-positive {
            background-color: rgba(128, 177, 34, 0.1); /* Green tint */
            color: var(--color-green);
            border: 1px solid var(--color-green);
        }
        .feedback-warning {
            background-color: rgba(255, 205, 34, 0.1); /* Yellow tint */
            color: var(--color-navy);
            border: 1px solid var(--color-yellow);
        }
        .feedback-alert {
            background-color: rgba(218, 55, 40, 0.1); /* Red tint */
            color: var(--color-red);
            border: 1px solid var(--color-red);
        }


        /* Input Section Layout */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-navy);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-navy);
        }
        
        /* Navigation/Action Buttons within Tabs */
        .tab-action-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Table/Row Styles - Unified Grid */
        /* New Grid Layout: Type (2), Category (3), Description (4), Amount (3), Actions (1) */
        .budget-table-header {
            display: grid;
            grid-template-columns: 1.5fr 2.5fr 3.5fr 2fr 0.5fr; /* 5 columns: Type, Category, Desc, Amount, Actions */
            font-weight: 700;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-navy);
            padding: 10px 0;
            gap: 10px;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .budget-data-row {
            display: grid;
            grid-template-columns: 1.5fr 2.5fr 3.5fr 2fr 0.5fr; /* Match header grid structure */
            padding: 10px 0;
            align-items: center;
            font-size: 0.9rem;
            gap: 10px;
        }
        
        .budget-data-row:nth-child(even) {
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        /* Styling for disabled/inactive category when type is 'Ingreso' */
        .category-input:disabled {
            background-color: var(--color-gray);
            border-color: #ccc;
            opacity: 0.6;
            cursor: not-allowed;
            /* Reset to default gray color when disabled */
            color: #666; 
        }

        /* Form Controls */
        input, select {
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: 0.9rem;
            transition: border-color 0.2s;
            width: 100%; /* Ensures they fill the grid column */
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            border-color: var(--color-sky-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 173, 225, 0.1);
        }

        input[type="number"] {
            text-align: right;
            /* Prevents non-numeric characters (e, +, -, .) - enforced via JS/oninput */
        }

        /* Buttons */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-family); /* Ensure Lexend */
        }

        .btn-add {
            background-color: var(--color-sky-blue);
            color: var(--color-white);
        }
        
        .btn-add:hover {
            background-color: #008fbb;
            transform: translateY(-1px);
        }
        
        .btn-nav {
            background-color: var(--color-violet);
            color: var(--color-white);
        }
        .btn-nav:hover {
            background-color: #484e84;
            transform: translateY(-1px);
        }


        .btn-remove {
            background-color: var(--color-red);
            color: var(--color-white);
            padding: 5px 8px;
            font-size: 0.8rem;
        }
        
        .btn-remove:hover {
            background-color: #b82d22;
        }

        .btn-export {
            background-color: var(--color-navy);
            color: var(--color-white);
            margin-top: 20px;
            width: 100%;
        }

        .btn-export:hover {
            background-color: #1a233b;
        }

        /* Tooltip (Info Icon) Styles - FIXED APPEARANCE */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            color: var(--color-sky-blue);
            margin-left: 5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--color-sky-blue); /* Solid blue background */
            font-weight: 700;
            line-height: 1;
        }
        
        /* Display the info icon (i) in white on the blue background */
        .tooltip-container::before {
            content: "i"; /* Use 'i' instead of 'ⓘ' to prevent nested circle appearance */
            font-style: normal;
            font-size: 0.8rem;
            color: var(--color-white);
            text-align: center;
            line-height: 1;
            padding-bottom: 1px; /* Visual adjustment for better centering */
        }
        
        /* This span holds the content, but is kept hidden by default */
        .tooltip-container span {
            display: none; 
        }

        .tooltip-text {
            visibility: hidden;
            background-color: var(--color-navy);
            color: var(--color-white);
            text-align: left; /* Changed to left for better readability in long text */
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position the tooltip above the icon */
            left: 50%;
            transform: translateX(-50%); /* Center horizontally */
            width: 250px; /* Increased width for description */
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-weight: 400;
            font-size: 0.85rem;
            display: block !important; /* Force display when active */
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%; /* At the bottom of the tooltip */
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--color-navy) transparent transparent transparent;
        }
        
        /* State when container is hovered/focused */
        .tooltip-container:hover .tooltip-text,
        .tooltip-container:focus-within .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Footer/Disclaimer */
        .footer-note {
            text-align: center;
            margin-top: 40px;
            font-size: 0.9rem;
            color: #666;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
        }
        
        /* Numeric Format Disclaimer - Less invasive */
        .format-disclaimer-subtle {
            background-color: rgba(255, 205, 34, 0.1);
            color: var(--color-navy);
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 20px;
            border: 1px solid var(--color-yellow);
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- RAE: Capitalization only on first word -->
        <h1>Planificador de presupuesto mensual</h1>
        <p class="disclaimer-title">
            Basado en el modelo 50/30/20 (Necesidades / Deseos / Ahorro)
            <span class="tooltip-container">
                <span class="tooltip-text">
                    El modelo 50/30/20 sugiere distribuir tus ingresos en: <strong>50% Necesidades</strong> (gastos esenciales y fijos), <strong>30% Deseos</strong> (gastos discrecionales y ocio), y <strong>20% Ahorro/Deuda</strong> (fondo de emergencia, inversión, o pago extra de deudas).
                </span>
            </span>
        </p>

        <!-- SUMMARY DASHBOARD CARD (Labels adjusted for RAE) -->
        <div class="summary-grid">
            
            <div id="total-income-display" class="summary-item card">
                <div class="summary-label">
                    Ingresos totales
                </div>
                <div class="summary-value" data-value="0">--</div>
            </div>

            <div id="total-expenses-display" class="summary-item card">
                <div class="summary-label">
                    Gastos totales
                </div>
                <div class="summary-value" data-value="0">--</div>
            </div>

            <div id="monthly-balance-display" class="summary-item card zero">
                <div class="summary-label">
                    Balance mensual
                </div>
                <div class="summary-value" data-value="0">--</div>
            </div>
        </div>

        <!-- TAB CONTROLS (Removed the tab bar entirely to force button navigation) -->
        <div class="tab-controls">
            <!-- These buttons are now only used for JS target, but are hidden -->
            <button id="tab-registro" class="tab-button" onclick="openTab(event, 'registro-content')">
                Registro de movimientos
            </button>
            <button id="tab-resumen" class="tab-button" onclick="openTab(event, 'resumen-content')">
                Resumen 50/30/20
            </button>
        </div>

        <!-- TAB CONTENT CONTAINER -->
        <div class="tab-container card" style="padding: 20px;">
            
            <!-- TAB 1: REGISTRO DE MOVIMIENTOS - CONSOLIDATED TABLE -->
            <div id="registro-content" class="tab-content active">

                <!-- Numeric Format Disclaimer - ADJUSTED FOR INTEGER INPUT (NO DECIMALS) -->
                <div class="format-disclaimer-subtle">
                    <strong>Formato de ingreso:</strong> Ingrese solo <strong>números enteros</strong> (sin decimales, ni signos negativos). <strong>No use comas ni puntos</strong> para separar los miles. La salida se muestra en formato de moneda local.
                </div>

                <div class="register-section">
                    <div class="section-header">
                        <h2 class="section-title">Registro de movimientos</h2>
                        <button class="btn btn-add" onclick="addRow()">
                            <span style="margin-right: 5px;">+ Agregar movimiento</span>
                        </button>
                    </div>
                    
                    <!-- Consolidated Table Header - Reordered columns -->
                    <div class="budget-table-header">
                        <div>
                            Tipo
                            <span class="tooltip-container">
                                <span class="tooltip-text">Seleccione si el movimiento es un **Ingreso** o un **Gasto**.</span>
                            </span>
                        </div>
                        <div>
                            Categoría (50/30/20)
                            <span class="tooltip-container">
                                <span class="tooltip-text">Clasificación obligatoria para **Gastos** según el modelo 50/30/20.</span>
                            </span>
                        </div>
                        <div>
                            Descripción
                            <span class="tooltip-container">
                                <span class="tooltip-text">Detalle del movimiento (ej: sueldo, arriendo, suscripción a plataforma).</span>
                            </span>
                        </div>
                        <div style="text-align: right;">
                            Monto ($)
                            <span class="tooltip-container">
                                <span class="tooltip-text">Valor numérico total. Ingrese solo números enteros.</span>
                            </span>
                        </div>
                        <div></div> <!-- Action column -->
                    </div>

                    <div id="budget-rows-container">
                        <!-- Rows will be injected here by JavaScript -->
                    </div>
                    
                    <!-- Navigation Button to Summary -->
                    <div class="tab-action-buttons">
                        <button class="btn btn-nav" onclick="showSummaryTab()">
                            Ver Resumen &rarr;
                        </button>
                    </div>

                </div>
            </div>

            <!-- TAB 2: RESUMEN 50/30/20 (Labels adjusted for RAE) -->
            <div id="resumen-content" class="tab-content">
                <div class="breakdown-layout">
                    
                    <!-- Chart & List Container (Side-by-side on desktop) -->
                    <div class="breakdown-card">
                        <!-- Chart Area -->
                        <div class="breakdown-chart-area">
                            <h2 class="section-title" style="margin-bottom: 10px;">
                                Distribución de gastos
                            </h2>
                            <!-- Canvas for the Donut Chart -->
                            <canvas id="chart-canvas" width="300" height="300"></canvas>
                        </div>
                        
                        <!-- Breakdown List Area -->
                        <div class="breakdown-list-area">
                            <h2 class="section-title" style="border-bottom: 2px solid var(--color-violet); padding-bottom: 10px;">
                                Análisis detallado
                            </h2>
                            
                            <div class="breakdown-item">
                                <div class="breakdown-label">
                                    Necesidades (meta 50% de ingreso)
                                </div>
                                <div class="breakdown-value-wrapper">
                                     <span class="breakdown-percentage" id="needs-percent">0%</span>
                                     <span class="breakdown-value" id="needs-total">$0</span>
                                </div>
                            </div>

                            <div class="breakdown-item">
                                <div class="breakdown-label">
                                    Deseos (meta 30% de ingreso)
                                </div>
                                <div class="breakdown-value-wrapper">
                                    <span class="breakdown-percentage" id="wants-percent">0%</span>
                                     <span class="breakdown-value" id="wants-total">$0</span>
                                </div>
                            </div>

                            <div class="breakdown-item">
                                <div class="breakdown-label">
                                    Ahorro/Deuda (meta 20% de ingreso)
                                </div>
                                <div class="breakdown-value-wrapper">
                                     <span class="breakdown-percentage" id="savings-percent">0%</span>
                                     <span class="breakdown-value" id="savings-total">$0</span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--color-border); font-weight: 600; text-align: right; color: var(--color-navy);">
                                Gasto total categorizado: <span id="category-sum">$0</span>
                            </div>

                            <button class="btn btn-export" onclick="exportToXLSX()">
                                <span style="margin-right: 8px;">Exportar resumen a .xlsx (Excel)</span>
                                <!-- Inline SVG for download icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Dynamic Feedback Message - Positioned full width after the breakdown card -->
                    <div id="feedback-message" class="feedback-message feedback-positive">
                        ¡Genial! Tu presupuesto sigue el modelo 50/30/20 de forma óptima.
                    </div>
                    
                    <!-- Navigation Button to Edit -->
                    <div class="tab-action-buttons">
                        <button class="btn btn-nav" onclick="showRegistroTab()">
                            &larr; Editar Movimientos
                        </button>
                    </div>

                </div>
            </div>
            
        </div> <!-- End of Tab Container -->
        
        <!-- Tool for the small note -->
        <p class="footer-note">
            Esta herramienta es informativa y no constituye asesoría financiera.
        </p>

    </div> <!-- End of container -->

    <script>
        // --- JAVASCRIPT LOGIC (English Comments) ---

        // Global data structure to hold all records
        let budgetData = []; 
        
        // Expense categories based on 50/30/20 rule
        const EXPENSE_CATEGORIES = {
            'needs': 'Necesidades (50%)',
            'wants': 'Deseos (30%)',
            'savings': 'Ahorro/Deuda (20%)'
        };

        const TRANSACTION_TYPES = {
            'income': 'Ingreso',
            'expense': 'Gasto'
        };

        // Chart Colors from Umine Kit Palette (mapped to categories)
        const CHART_COLORS = {
            'needs': '#575e9a',    // Violet (Primary Expense)
            'wants': '#ffcd22',    // Yellow (Wants/Discretionary)
            'savings': '#80b122',  // Green (Savings/Positive)
            'unspent': '#ececec',  // Gray (Unspent/Remaining Income)
            'overspent': '#da3728' // Red (Overspent/Deficit)
        };
        
        // --- Tab Control Logic ---

        /**
         * Opens the specified tab content and sets the active state on the button.
         * @param {Event} evt - The click event.
         * @param {string} tabName - The ID of the tab content to show.
         */
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;

            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }

            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            // Handle case where evt is passed (click event from button)
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            } else {
                // Handle case where it's called programmatically (like during init or nav buttons)
                const targetButton = document.getElementById(`tab-${tabName.replace('-content', '')}`);
                if (targetButton) {
                    targetButton.classList.add("active");
                }
            }

            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            
            // Re-render totals and chart when switching tabs
            updateTotals();
        }
        
        /**
         * Navigates to the Summary tab programmatically.
         */
        function showSummaryTab() {
            // Simulate event object for openTab function
            openTab({ currentTarget: document.getElementById('tab-resumen') }, 'resumen-content');
        }
        
        /**
         * Navigates to the Registro tab programmatically.
         */
        function showRegistroTab() {
            // Simulate event object for openTab function
            openTab({ currentTarget: document.getElementById('tab-registro') }, 'registro-content');
        }


        // --- Utility Functions ---

        /**
         * Safely parse a value to an integer, returning 0 if parsing fails or if negative.
         * @param {string} value - The string value to parse.
         * @returns {number} The parsed non-negative integer or 0.
         */
        function parseValue(value) {
            // Remove all non-numeric characters
            const numString = String(value).replace(/[^0-9]/g, '');
            const num = parseInt(numString, 10);
            return isNaN(num) || num < 0 ? 0 : num;
        }

        /**
         * Formats a number as currency (local style).
         * @param {number} amount - The amount to format.
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(amount) {
            // Using 'es-CL' for Chilean Peso formatting, enforcing 0 decimal digits.
            return new Intl.NumberFormat('es-CL', { 
                style: 'currency', 
                currency: 'CLP', // Placeholder currency
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        /**
         * Formats a number as a percentage.
         * @param {number} ratio - The ratio (0 to 1) to format.
         * @returns {string} Formatted percentage string.
         */
        function formatPercentage(ratio) {
            return new Intl.NumberFormat('es-ES', { 
                style: 'percent', 
                minimumFractionDigits: 1, 
                maximumFractionDigits: 1 
            }).format(ratio);
        }


        // --- Data Persistence and Loading ---

        /**
         * Saves the current budget data to localStorage.
         */
        function saveData() {
            try {
                localStorage.setItem('budgetPlannerDataUnified', JSON.stringify(budgetData));
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
            }
        }

        /**
         * Loads budget data from localStorage and initializes the UI.
         */
        function loadData() {
            try {
                const storedData = localStorage.getItem('budgetPlannerDataUnified');
                if (storedData) {
                    budgetData = JSON.parse(storedData);
                    if (!Array.isArray(budgetData)) budgetData = [];
                } else {
                    // Initialize with default rows if no data exists (using whole numbers)
                    budgetData.push({ id: Date.now() + 1, type: 'income', desc: 'Sueldo', category: null, amount: 800000 });
                    budgetData.push({ id: Date.now() + 2, type: 'expense', desc: 'Arriendo', category: 'needs', amount: 350000 });
                    budgetData.push({ id: Date.now() + 3, type: 'expense', desc: 'Ahorro emergencia', category: 'savings', amount: 100000 });
                    budgetData.push({ id: Date.now() + 4, type: 'expense', desc: 'Suscripción Netflix', category: 'wants', amount: 12000 });
                }
            } catch (error) {
                console.error('Error loading or parsing data from localStorage:', error);
                // Fallback to default structure
                budgetData = [];
                budgetData.push({ id: Date.now() + 1, type: 'income', desc: 'Sueldo', category: null, amount: 800000 });
                budgetData.push({ id: Date.now() + 2, type: 'expense', desc: 'Arriendo', category: 'needs', amount: 350000 });
                budgetData.push({ id: Date.now() + 3, type: 'expense', desc: 'Ahorro emergencia', category: 'savings', amount: 100000 });
                budgetData.push({ id: Date.now() + 4, type: 'expense', desc: 'Suscripción Netflix', category: 'wants', amount: 12000 });
            }
            
            // Render the loaded data to the DOM
            renderRows();
            updateTotals();
        }


        // --- DOM Rendering and Manipulation ---

        /**
         * Validates input in real-time, enforcing non-negative integers only.
         * This handles mobile/copy-paste/keyboard events beyond basic input type="number" restrictions.
         * @param {HTMLInputElement} inputElement - The input element.
         */
        function enforcePositiveInteger(inputElement) {
            // 1. Filter out non-digit characters and ensure non-negative.
            let value = inputElement.value.replace(/[^0-9]/g, '');
            if (value === '') value = '0'; // Prevent empty string if all characters are removed
            
            // 2. Update the element's value (this also prevents input of negative sign/e/.)
            inputElement.value = value;
            
            // 3. Immediately trigger the data update logic
            const id = parseInt(inputElement.closest('.budget-data-row').dataset.id);
            updateRowData(id, 'amount', value); 
            updateTotals();
            saveData();
        }

        /**
         * Generates the HTML for a single budget row (unified).
         * @param {Object} row - The transaction data object.
         * @returns {string} HTML string for the row.
         */
        function createBudgetRowHTML(row) {
            const expenseOptions = Object.entries(EXPENSE_CATEGORIES).map(([key, label]) => 
                `<option value="${key}" ${row.category === key ? 'selected' : ''}>${label}</option>`
            ).join('');

            const typeOptions = Object.entries(TRANSACTION_TYPES).map(([key, label]) => 
                `<option value="${key}" ${row.type === key ? 'selected' : ''}>${label}</option>`
            ).join('');

            const isIncome = row.type === 'income';

            // Category select properties for disabling when income
            const categoryDisabled = isIncome ? 'disabled' : '';
            const categoryTabindex = isIncome ? 'tabindex="-1"' : '';

            // Note: The structure here MUST match the CSS grid layout (5 columns)
            return `
                <div class="budget-data-row" data-id="${row.id}" data-type="${row.type}">
                    <select onchange="updateRowType(${row.id}, this.value); renderRows(); updateTotals(); saveData();">
                        ${typeOptions}
                    </select>
                    
                    <select onchange="updateRowData(${row.id}, 'category', this.value); updateTotals(); saveData();" 
                            class="category-input" ${categoryDisabled} ${categoryTabindex}>
                        <option value="" disabled selected ${!row.category && isIncome ? 'hidden' : ''}>Seleccione Categoría</option>
                        ${expenseOptions}
                    </select>

                    <input type="text" value="${row.desc}" placeholder="Ej: sueldo, arriendo" class="description-input"
                           oninput="updateRowData(${row.id}, 'desc', this.value); saveData();">
                    
                    <!-- Enforce integer input via oninput handler -->
                    <input type="number" step="1" min="0" value="${row.amount}" placeholder="0" 
                           oninput="enforcePositiveInteger(this);" style="text-align: right;">
                    
                    <button class="btn btn-remove" onclick="removeRow(${row.id})">
                        &times;
                    </button>
                </div>
            `;
        }

        /**
         * Renders all budget rows to the DOM.
         */
        function renderRows() {
            const container = document.getElementById(`budget-rows-container`);
            if (!container) return;

            const html = budgetData.map(row => createBudgetRowHTML(row)).join('');
            container.innerHTML = html;
        }

        /**
         * Adds a new row to the data and redraws.
         */
        function addRow() {
            const newId = Date.now();
            // Default new row to an expense
            budgetData.push({ id: newId, type: 'expense', desc: '', category: 'needs', amount: 0 });
            
            renderRows();
            updateTotals();
            saveData();
        }
        
        /**
         * Removes a row by ID from the data and redraws.
         * @param {number} id - The unique ID of the row.
         */
        function removeRow(id) {
            budgetData = budgetData.filter(row => row.id !== id);
            
            // If the section becomes empty, add a default empty row to keep UI clean
            if (budgetData.length === 0) {
                budgetData.push({ id: Date.now(), type: 'expense', desc: '', category: 'needs', amount: 0 });
            } 
            
            renderRows();
            updateTotals();
            saveData();
        }

        /**
         * Updates the transaction type (income/expense) for a row and adjusts category if needed.
         * @param {number} id - The unique ID of the row.
         * @param {string} newType - The new type ('income' or 'expense').
         */
        function updateRowType(id, newType) {
            const row = budgetData.find(r => r.id === id);
            if (row) {
                row.type = newType;
                // If switching to income, clear category
                if (newType === 'income') {
                    row.category = null;
                } 
                // If switching to expense, ensure a default category is set if none exists
                else if (newType === 'expense' && !row.category) {
                    row.category = 'needs';
                }
            }
        }

        /**
         * Updates a specific field (desc, amount, category) for a row in the data.
         * @param {number} id - The unique ID of the row.
         * @param {string} field - The field to update ('desc', 'amount', 'category').
         * @param {string | number} value - The new value.
         */
        function updateRowData(id, field, value) {
            const row = budgetData.find(r => r.id === id);
            if (row) {
                if (field === 'amount') {
                    // parseValue handles cleaning and ensuring non-negative integer
                    row.amount = parseValue(value);
                } else {
                    row[field] = value;
                }
            }
        }
        
        // --- Chart Drawing Logic ---
        
        /**
         * Draws the donut chart based on category percentages. (Function is lengthy but unchanged logic-wise, 
         * just ensuring it uses correct font properties for the canvas.)
         */
        function drawChart(needsPct, wantsPct, savingsPct, totalIncome, totalExpenses) {
            const canvas = document.getElementById('chart-canvas');
            if (!canvas) return; 

            const size = canvas.width;
            const ctx = canvas.getContext('2d');
            const centerX = size / 2;
            const centerY = size / 2;
            const outerRadius = size / 2 * 0.9;
            const innerRadius = outerRadius * 0.6; 
            let startAngle = 0;
            
            ctx.clearRect(0, 0, size, size);
            
            const totalSpentPct = needsPct + wantsPct + savingsPct;
            let finalData = [];
            
            let scaleFactor = totalSpentPct > 1.0 ? 1.0 / totalSpentPct : 1.0;
            
            // Build the data array for the chart segments
            finalData.push({ percent: needsPct * scaleFactor, color: CHART_COLORS.needs, label: 'Necesidades' });
            finalData.push({ percent: wantsPct * scaleFactor, color: CHART_COLORS.wants, label: 'Deseos' });
            finalData.push({ percent: savingsPct * scaleFactor, color: CHART_COLORS.savings, label: 'Ahorro' });

            // Add 'Unspent' portion if total consumption is less than 100% of income
            if (totalSpentPct < 1.0) {
                const unspentPct = 1.0 - totalSpentPct;
                finalData.push({ percent: unspentPct, color: CHART_COLORS.unspent, label: 'Disponible' });
            }
            
            // Draw the slices
            finalData.forEach(segment => {
                const sliceAngle = segment.percent * 2 * Math.PI;
                
                ctx.beginPath();
                // Arc 1: Outer edge
                ctx.arc(centerX, centerY, outerRadius, startAngle, startAngle + sliceAngle);
                
                // Line to inner circle (start of inner arc)
                const innerStartX = centerX + innerRadius * Math.cos(startAngle + sliceAngle);
                const innerStartY = centerY + innerRadius * Math.sin(startAngle + sliceAngle);
                ctx.lineTo(innerStartX, innerStartY);

                // Arc 2: Inner edge (drawn in reverse direction)
                ctx.arc(centerX, centerY, innerRadius, startAngle + sliceAngle, startAngle, true);
                
                ctx.closePath();
                
                ctx.fillStyle = segment.color;
                ctx.fill();
                
                startAngle += sliceAngle;
            });
            
            // Draw Center Text (Total Income)
            const rootStyle = getComputedStyle(document.documentElement);
            const navyColor = rootStyle.getPropertyValue('--color-navy').trim();
            // Get font family directly from the variable
            const fontFamily = rootStyle.getPropertyValue('--font-family').trim().replace(/['"]/g, '');

            // 1. Income Value
            ctx.fillStyle = totalIncome > 0 ? navyColor : rootStyle.getPropertyValue('--color-text-dark').trim();
            // Ensure font definition is correct
            ctx.font = `500 0.9rem ${fontFamily}`; 
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            let displayIncome = formatCurrency(totalIncome);
            if (displayIncome.length > 10) { 
                displayIncome = formatCurrency(Math.round(totalIncome / 1000)) + 'k';
            }
            
            ctx.fillText(displayIncome, centerX, centerY - 10);
            
            // 2. Label
            ctx.font = `400 0.7rem ${fontFamily}`; // Ensure font definition is correct
            ctx.fillText('Ingreso Total', centerX, centerY + 15);
        }

        /**
         * Generates and displays the friendly feedback message based on 50/30/20 compliance.
         * **SIMPLIFIED FOR BREVITY AND DIRECTNESS**
         * @param {number} totalIncome - Total calculated income.
         * @param {Object} categoryPcts - Object containing needs, wants, and savings percentages (0 to 1).
         * @param {number} balance - Monthly balance.
         */
        function updateFeedbackMessage(totalIncome, categoryPcts, balance) {
            const needsP = categoryPcts.needs;
            const wantsP = categoryPcts.wants;
            const savingsP = categoryPcts.savings;
            const $msgEl = document.getElementById('feedback-message');
            
            let message = '';
            let className = 'feedback-positive';
            const buffer = 0.01; // 1% tolerance buffer
            let complianceProblems = [];
            
            if (totalIncome === 0) {
                className = 'feedback-warning';
                message = 'Ingresa tu **ingreso principal** para obtener un análisis 50/30/20.';
            } else if (balance < 0) {
                className = 'feedback-alert';
                message = `¡**Déficit**! Tu gasto supera el ingreso por ${formatCurrency(Math.abs(balance))}. Prioriza y ajusta tus gastos.`;
            } else {
                // Check 50% Needs
                if (needsP > 0.5 + buffer) {
                    complianceProblems.push(`- **Necesidades:** Te estás excediendo del 50% ideal (${formatPercentage(needsP)}). Revisa gastos fijos.`);
                }
                
                // Check 30% Wants
                if (wantsP > 0.3 + buffer) {
                    complianceProblems.push(`- **Deseos:** Excedes el 30% ideal (${formatPercentage(wantsP)}). Identifica gastos discrecionales que puedes reducir.`);
                }
                
                // Check 20% Savings/Debt
                if (savingsP < 0.2 - buffer) {
                    complianceProblems.push(`- **Ahorro/Deuda:** Estás por debajo del 20% ideal (${formatPercentage(savingsP)}). Incrementa tu ahorro o pago de deudas.`);
                } else if (savingsP > 0.2 + buffer) {
                    complianceProblems.push(`¡**Excelente Ahorro!** Estás destinando más del 20% recomendado (${formatPercentage(savingsP)}).`);
                }
                
                // --- Final Message Logic ---
                if (complianceProblems.length > 0) {
                    const excellentSavings = complianceProblems.find(msg => msg.includes('¡Excelente Ahorro!'));
                    
                    if (complianceProblems.length === 1 && excellentSavings) {
                        className = 'feedback-positive';
                        message = `¡Felicidades! ${excellentSavings.replace('¡Excelente Ahorro! ', '')}`;
                    } else if (excellentSavings) {
                        className = 'feedback-warning';
                        let baseMsg = `**¡Logros y ajustes!** Tienes un buen ahorro, pero optimiza lo siguiente:\n`;
                        baseMsg += complianceProblems.filter(msg => !msg.includes('¡Excelente Ahorro!')).join('\n');
                        baseMsg += `\n${excellentSavings.replace('-', '•')}`;
                        message = baseMsg;
                    } else {
                        className = 'feedback-warning';
                        message = `**¡Oportunidades de mejora!** Tu distribución está desbalanceada. Te recomendamos revisar:\n` + complianceProblems.join('\n');
                    }
                } else {
                    className = 'feedback-positive';
                    message = '¡Felicidades! Tu distribución de gastos está **perfectamente alineada con el modelo 50/30/20**. ¡Control total!';
                }
            }
            
            // Apply formatting and update HTML
            $msgEl.className = `feedback-message ${className}`;
            
            // Replace **bold** with <strong> and handle newlines for display
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert newline characters for multi-line display, replacing list markers where needed
            $msgEl.innerHTML = message.replace(/\n/g, '<br>').replace(/^-/gm, '•');
        }


        // --- Core Calculation and Display Logic ---

        /**
         * Recalculates all totals, percentages, and updates the summary display and chart.
         */
        function updateTotals() {
            let totalIncome = 0;
            let totalExpenses = 0;
            const categoryTotals = { needs: 0, wants: 0, savings: 0 };
            
            // 1. Calculate Total Income and Total Expenses
            budgetData.forEach(row => {
                // Ensure amount is processed as a clean positive integer
                const amount = parseValue(row.amount);
                if (row.type === 'income') {
                    totalIncome += amount;
                } else if (row.type === 'expense') {
                    totalExpenses += amount;
                    // Aggregate expense totals by category
                    if (categoryTotals.hasOwnProperty(row.category)) {
                        categoryTotals[row.category] += amount;
                    }
                }
            });
            
            // 2. Calculate Balance
            const balance = totalIncome - totalExpenses;
            
            // 3. Calculate Percentages
            const categoryPcts = {
                needs: totalIncome > 0 ? categoryTotals.needs / totalIncome : 0,
                wants: totalIncome > 0 ? categoryTotals.wants / totalIncome : 0,
                savings: totalIncome > 0 ? categoryTotals.savings / totalIncome : 0
            };

            // 4. Update Summary Dashboard
            
            const incomeDisplay = document.querySelector('#total-income-display .summary-value');
            const expensesDisplay = document.querySelector('#total-expenses-display .summary-value');
            const balanceDisplay = document.getElementById('monthly-balance-display');
            const balanceValueDisplay = balanceDisplay.querySelector('.summary-value');

            // Update text content with formatted currency
            incomeDisplay.textContent = formatCurrency(totalIncome);
            expensesDisplay.textContent = formatCurrency(totalExpenses);
            balanceValueDisplay.textContent = formatCurrency(balance);

            // Color-code balance
            balanceDisplay.classList.remove('positive', 'negative', 'zero');
            if (balance > 0) {
                balanceDisplay.classList.add('positive');
            } else if (balance < 0) {
                balanceDisplay.classList.add('negative');
            } else {
                balanceDisplay.classList.add('zero');
            }
            
            // 5. Update 50/30/20 Breakdown List
            const totalCategorized = categoryTotals.needs + categoryTotals.wants + categoryTotals.savings;
            document.getElementById('category-sum').textContent = formatCurrency(totalCategorized);

            // Function to update breakdown list display
            const updateCategoryDisplay = (id, total, idealPercentage, percentage) => {
                const totalEl = document.getElementById(`${id}-total`);
                const percentEl = document.getElementById(`${id}-percent`);
                
                totalEl.textContent = formatCurrency(total);
                percentEl.textContent = formatPercentage(percentage);
                
                // Color-code percentage relative to the IDEAL (50%, 30%, 20%)
                percentEl.classList.remove('ok', 'over');
                // Check if real expenditure exceeds the ideal percentage (with a small buffer)
                if (percentage > idealPercentage + 0.01) { // 1% buffer
                    percentEl.classList.add('over'); // Red color
                } else {
                    percentEl.classList.add('ok'); // Green color
                }
            };
            
            // 50% Needs, 30% Wants, 20% Savings/Debt
            updateCategoryDisplay('needs', categoryTotals.needs, 0.5, categoryPcts.needs);
            updateCategoryDisplay('wants', categoryTotals.wants, 0.3, categoryPcts.wants);
            updateCategoryDisplay('savings', categoryTotals.savings, 0.2, categoryPcts.savings);
            
            // 6. Update Chart and Feedback
            drawChart(categoryPcts.needs, categoryPcts.wants, categoryPcts.savings, totalIncome, totalExpenses);
            updateFeedbackMessage(totalIncome, categoryPcts, balance);

            // Save data after calculation completes
            saveData();
        }

        // --- Export Functionality (Using CSV for robustness) ---

        /**
         * Cleans a string for safe use within a CSV cell (handling commas and quotes).
         * @param {string} str - The string to clean.
         * @returns {string} The CSV-safe string.
         */
        function csvClean(str) {
            if (typeof str === 'number') return str;
            // Replace double quotes with two double quotes, then wrap the whole string in quotes if it contains the delimiter (;) or a newline.
            str = String(str).replace(/"/g, '""');
            if (str.includes(';') || str.includes('\n') || str.includes('\r')) {
                return `"${str}"`;
            }
            return str;
        }

        /**
         * Exports the current budget data and summary as a highly compatible CSV file, 
         * using the .xlsx extension for better Excel opening experience.
         */
        function exportToXLSX() {
            // Use SEMICOLON as delimiter (standard for CSV in many Latin American Excel localizations)
            const DELIMITER = ';';

            // --- 1. Calculate Data ---
            const totalIncome = budgetData.filter(r => r.type === 'income').reduce((sum, row) => sum + parseValue(row.amount), 0);
            const totalExpenses = budgetData.filter(r => r.type === 'expense').reduce((sum, row) => sum + parseValue(row.amount), 0);
            const balance = totalIncome - totalExpenses;
            const categoryTotals = { needs: 0, wants: 0, savings: 0 };
            budgetData.filter(r => r.type === 'expense').forEach(row => {
                if (categoryTotals.hasOwnProperty(row.category)) {
                    categoryTotals[row.category] += parseValue(row.amount);
                }
            });
            const needsPct = totalIncome > 0 ? categoryTotals.needs / totalIncome : 0;
            const wantsPct = totalIncome > 0 ? categoryTotals.wants / totalIncome : 0;
            const savingsPct = totalIncome > 0 ? categoryTotals.savings / totalIncome : 0;
            const totalCategorized = categoryTotals.needs + categoryTotals.wants + categoryTotals.savings;

            let csvContent = '';

            // --- 2. Summary Section ---
            csvContent += csvClean('RESUMEN GENERAL') + DELIMITER + DELIMITER + '\n';
            csvContent += csvClean('Ingresos Totales') + DELIMITER + totalIncome + DELIMITER + '\n';
            csvContent += csvClean('Gastos Totales') + DELIMITER + totalExpenses + DELIMITER + '\n';
            csvContent += csvClean('Balance Mensual') + DELIMITER + balance + DELIMITER + '\n';
            csvContent += '\n';

            // --- 3. 50/30/20 Breakdown Section ---
            csvContent += csvClean('DISTRIBUCIÓN 50/30/20') + DELIMITER + DELIMITER + DELIMITER + DELIMITER + '\n';
            csvContent += csvClean('Categoría') + DELIMITER + csvClean('Gasto Real ($)') + DELIMITER + csvClean('% Ingreso Total') + DELIMITER + csvClean('Meta Ideal') + '\n';

            csvContent += csvClean('Necesidades (50%)') + DELIMITER + categoryTotals.needs + DELIMITER + needsPct + DELIMITER + csvClean('50%') + '\n';
            csvContent += csvClean('Deseos (30%)') + DELIMITER + categoryTotals.wants + DELIMITER + wantsPct + DELIMITER + csvClean('30%') + '\n';
            csvContent += csvClean('Ahorro/Deuda (20%)') + DELIMITER + categoryTotals.savings + DELIMITER + savingsPct + DELIMITER + csvClean('20%') + '\n';
            csvContent += csvClean('Total Categorizado') + DELIMITER + totalCategorized + DELIMITER + DELIMITER + '\n';
            csvContent += '\n';

            // --- 4. Detail Data Section ---
            csvContent += csvClean('REGISTRO DE MOVIMIENTOS') + DELIMITER + DELIMITER + DELIMITER + DELIMITER + '\n';
            csvContent += csvClean('Tipo') + DELIMITER + csvClean('Categoría (50/30/20)') + DELIMITER + csvClean('Descripción') + DELIMITER + csvClean('Monto ($)') + '\n';

            budgetData.forEach(row => {
                const amount = parseValue(row.amount);
                const typeLabel = TRANSACTION_TYPES[row.type] || 'Desconocido';
                const categoryLabel = row.type === 'expense' ? (EXPENSE_CATEGORIES[row.category] || 'Sin categoría') : '--';
                
                csvContent += csvClean(typeLabel) + DELIMITER + csvClean(categoryLabel) + DELIMITER + csvClean(row.desc) + DELIMITER + amount + '\n';
            });

            // Create Blob with UTF-8 BOM for proper character handling in Excel
            const BOM = "\uFEFF"; 
            const blob = new Blob([BOM + csvContent], { 
                type: 'text/csv;charset=utf-8;'
            });
            
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            // Crucial: Use .csv extension now. Excel or Sheets will open it correctly based on the semicolon delimiter.
            link.setAttribute("download", "presupuesto_mensual.csv"); 
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // OPTIONAL: Inform the user about the change
            alert("El archivo se ha descargado como 'presupuesto_mensual.csv'. Por favor, ábrelo o impórtalo en Excel. (Se usa el punto y coma ';' como separador para asegurar la compatibilidad regional).");
        }

        // --- Initial Load ---
        window.onload = () => {
            loadData();
            // Manually activate the first tab on load, in case of browser inconsistencies
            const defaultTab = document.querySelector('#tab-registro');
            if (defaultTab) {
                // The openTab function expects an event object, we simulate it for initialization
                openTab(null, 'registro-content'); // Pass null for event, use ID for tab
            }
        };

    </script>
</body>
</html>
